<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="format-detection" content="telephone=no, date=no, email=no, address=no">
<meta name="theme-color" content="#0D1117">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>My Drive Log</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script>
// Maps JS API loaded immediately at page open â€” ready before user taps Start Trip
window._mapsReady = false;
window._mapsQueue = [];
function _mapsCallback(){ 
  window._mapsReady = true; 
  window._mapsQueue.forEach(fn=>fn()); 
  window._mapsQueue=[]; 
}
</script>
<style>
/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --bg:#0D1117; --surface:#161B27; --card:#1C2333; --border:#252E45;
  --accent:#00D4AA; --blue:#3B82F6; --warn:#F59E0B; --danger:#EF4444;
  --yellow:#FFD60A; --text:#E6EDF3; --muted:#6E7A99;
  --nav-h:62px;
  --tada:#F97316; --grab:#00B14F; --gojek:#38BDF8; --others:#A78BFA;
  --r:12px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:var(--bg);color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:15px;line-height:1.5}
button{font-family:'DM Sans',sans-serif;cursor:pointer}
input,textarea{font-family:'DM Sans',sans-serif}
::-webkit-scrollbar{width:2px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{height:100%;display:flex;flex-direction:column;overflow:hidden}
.screen{display:none;flex:1;overflow-y:auto;padding-bottom:calc(var(--nav-h)+16px)}
.screen.active{display:block}

/* â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
nav{
  position:fixed;bottom:0;left:0;right:0;height:var(--nav-h);
  background:var(--surface);border-top:1px solid var(--border);
  display:grid;grid-template-columns:repeat(5,1fr);z-index:200
}
.nb{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;border:none;background:none;color:var(--muted);
  font-size:9px;font-weight:600;letter-spacing:.4px;padding:6px 2px;
  transition:color .15s;position:relative
}
.nb svg{width:21px;height:21px;stroke-width:1.8}
.nb.on{color:var(--accent)}
.nb.on svg{stroke:var(--accent)}

/* â”€â”€ PAGE HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ph{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:14px 16px 10px;position:sticky;top:0;z-index:50
}
.ph-title{font-family:'Space Mono',monospace;font-size:12px;color:var(--accent);
  letter-spacing:1.5px;text-transform:uppercase}
.ph-sub{font-size:11px;color:var(--muted);margin-top:2px}

/* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:14px 14px;margin:10px 12px 0}
.card-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);
  letter-spacing:1px;text-transform:uppercase;margin-bottom:10px}

/* â”€â”€ INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.lbl{font-size:11px;color:var(--muted);font-weight:500;margin-bottom:5px;display:block;letter-spacing:.3px}
.inp{
  width:100%;background:var(--bg);border:1.5px solid var(--border);
  border-radius:8px;padding:11px 12px;color:var(--text);font-size:15px;
  outline:none;transition:border-color .2s
}
.inp:focus{border-color:var(--accent)}
.inp::placeholder{color:var(--muted)}
textarea.inp{resize:none;height:80px}

/* â”€â”€ TOGGLE ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tog-row{display:flex;gap:7px}
.tog{
  flex:1;padding:10px 6px;border:1.5px solid var(--border);border-radius:8px;
  background:transparent;color:var(--muted);font-size:13px;font-weight:600;
  transition:all .15s;text-align:center
}
.tog.on        {border-color:var(--accent);color:var(--accent);background:rgba(0,212,170,.08)}
.tog.on-danger {border-color:var(--danger);color:var(--danger);background:rgba(239,68,68,.08)}
.tog.on-tada   {border-color:var(--tada);color:var(--tada);background:rgba(249,115,22,.08)}
.tog.on-grab   {border-color:var(--grab);color:var(--grab);background:rgba(0,177,79,.08)}
.tog.on-gojek  {border-color:var(--gojek);color:var(--gojek);background:rgba(56,189,248,.08)}
.tog.on-others {border-color:var(--others);color:var(--others);background:rgba(167,139,250,.08)}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  display:flex;align-items:center;justify-content:center;gap:8px;
  border:none;border-radius:10px;padding:14px 18px;font-weight:600;
  font-size:15px;width:100%;transition:opacity .15s
}
.btn:active{opacity:.8}
.btn-green{background:var(--accent);color:#0D1117}
.btn-red{background:var(--danger);color:#fff}
.btn-gray{background:var(--border);color:var(--text)}
.btn-outline{background:transparent;border:1.5px solid var(--accent);color:var(--accent)}

/* â”€â”€ KPI ROW (Summary) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-row{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--r);padding:14px 16px;margin:0 12px;
}
.kpi-row+.kpi-row{margin-top:6px}
.kpi-row.star-yellow{border-color:rgba(255,214,10,.4);background:rgba(255,214,10,.04)}
.kpi-row.star-green {border-color:rgba(0,212,170,.4);background:rgba(0,212,170,.04)}
.kpi-row.star-amber {border-color:rgba(245,158,11,.4);background:rgba(245,158,11,.04)}
.kpi-lbl{font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px}
.kpi-val{font-family:'Space Mono',monospace;font-size:16px;font-weight:700;color:var(--text)}
.kpi-val.yellow{color:var(--yellow)}
.kpi-val.green {color:var(--accent)}
.kpi-val.amber {color:var(--warn)}

/* â”€â”€ TODAY BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.today-banner{
  display:grid;grid-template-columns:1fr 1fr 1fr;
  background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  margin:10px 12px 0;overflow:hidden
}
.tb-cell{padding:12px 10px;text-align:center}
.tb-cell:not(:last-child){border-right:1px solid var(--border)}
.tb-label{font-size:9px;font-weight:600;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;margin-bottom:4px}
.tb-val{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;color:var(--text)}

/* â”€â”€ MONTH NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mnav{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:50
}
.mnav-btn{
  background:var(--card);border:1px solid var(--border);color:var(--text);
  width:34px;height:34px;border-radius:8px;border:none;font-size:18px;
  display:flex;align-items:center;justify-content:center
}
.mnav-title{font-family:'Space Mono',monospace;font-size:14px;font-weight:700;letter-spacing:2px}

/* â”€â”€ PLATFORM PILL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ppill{
  display:inline-flex;align-items:center;font-size:10px;font-weight:700;
  padding:3px 8px;border-radius:99px;letter-spacing:.3px
}
.ppill-TADA  {background:rgba(249,115,22,.12);color:var(--tada)}
.ppill-Grab  {background:rgba(0,177,79,.12);color:var(--grab)}
.ppill-Gojek {background:rgba(56,189,248,.12);color:var(--gojek)}
.ppill-Others{background:rgba(167,139,250,.12);color:var(--others)}

/* â”€â”€ PLATFORM BOX (Entry card 2 & session) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.plat-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-top:8px}
.plat-box{
  background:var(--bg);border:1px solid var(--border);border-radius:8px;
  padding:8px 6px;text-align:left
}
.plat-box-name{font-size:9px;font-weight:700;letter-spacing:.5px;margin-bottom:4px}
.plat-box-val{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--text)}

/* â”€â”€ SESSION BLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sess-block{
  background:var(--bg);border:1.5px solid var(--blue);border-radius:10px;
  padding:12px;margin-top:10px
}
.sess-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--blue);
  letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}

/* â”€â”€ TRIP CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.trip-card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:13px;margin:8px 12px 0
}
.trip-fare{font-family:'Space Mono',monospace;font-size:18px;font-weight:700;color:var(--accent)}
.trip-route{font-size:13px;font-weight:600;margin:6px 0 4px;color:var(--text)}
.trip-meta{font-size:11px;color:var(--muted);display:flex;gap:12px}

/* â”€â”€ HISTORY DAY CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.hist-card{
  background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:13px;margin:8px 12px 0
}

/* â”€â”€ SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  z-index:300;display:none;align-items:flex-end
}
.overlay.open{display:flex}
.sheet{
  background:var(--surface);border-radius:20px 20px 0 0;
  padding:20px 16px 36px;width:100%;max-height:90vh;overflow-y:auto;
  animation:up .22s ease
}
@keyframes up{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle{width:36px;height:4px;background:var(--border);border-radius:99px;margin:0 auto 16px}
.sheet-title{font-family:'Space Mono',monospace;font-size:12px;font-weight:700;
  text-align:center;letter-spacing:1px;margin-bottom:16px;color:var(--text)}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{
  position:fixed;bottom:calc(var(--nav-h)+14px);left:50%;transform:translateX(-50%);
  background:var(--accent);color:#0D1117;padding:10px 22px;border-radius:99px;
  font-weight:700;font-size:13px;z-index:400;opacity:0;
  transition:opacity .25s;white-space:nowrap;pointer-events:none
}
.toast.show{opacity:1}

/* â”€â”€ GPS STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gps{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;font-size:12px;margin-bottom:10px}
.gps.search{background:rgba(245,158,11,.08);color:var(--warn);border:1px solid rgba(245,158,11,.2)}
.gps.ok    {background:rgba(0,212,170,.08);color:var(--accent);border:1px solid rgba(0,212,170,.2)}
.gps.err   {background:rgba(239,68,68,.08);color:var(--danger);border:1px solid rgba(239,68,68,.2)}
.gps-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.pulse{animation:pulse 1.1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.2}}
.dot-warn{background:var(--warn)} .dot-ok{background:var(--accent)} .dot-err{background:var(--danger)}

/* â”€â”€ MISC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.divider{height:1px;background:var(--border);margin:12px 0}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.empty{text-align:center;padding:40px 20px;color:var(--muted);font-size:13px}

/* â”€â”€ FARE INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.fare-wrap{display:flex;align-items:center;justify-content:center;gap:4px;margin:12px 0}
.fare-prefix{font-family:'Space Mono',monospace;font-size:28px;color:var(--muted)}
.fare-inp{
  background:transparent;border:none;outline:none;
  font-family:'Space Mono',monospace;font-size:38px;font-weight:700;
  color:var(--accent);width:160px;text-align:center
}

/* â”€â”€ ACTIVE TRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.active-trip-card{
  margin:10px 12px 0;background:rgba(0,212,170,.06);
  border:2px solid var(--accent);border-radius:var(--r);padding:14px
}
.live-badge{display:flex;align-items:center;gap:6px;font-family:'Space Mono',monospace;
  font-size:9px;color:var(--accent);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);animation:pulse 1s infinite}
.timer{font-family:'Space Mono',monospace;font-size:32px;font-weight:700;
  color:var(--accent);text-align:center;margin:6px 0;letter-spacing:3px}

/* â”€â”€ START TRIP BTN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.start-btn{
  position:fixed;bottom:calc(var(--nav-h)+10px);left:12px;right:12px;
  background:linear-gradient(135deg,#00D4AA,#00B890);
  color:#0D1117;border:none;border-radius:14px;padding:17px;
  display:flex;align-items:center;justify-content:center;gap:10px;
  font-size:16px;font-weight:700;box-shadow:0 4px 20px rgba(0,212,170,.3);
  z-index:90;transition:all .2s
}
.start-btn:active{transform:scale(.97)}
.start-btn:disabled{opacity:.35;cursor:not-allowed}
#screen-trips{padding-bottom:calc(var(--nav-h)+80px)}

/* â”€â”€ TODAY TRIP SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.trip-summary-card{
  margin:10px 12px 0;
  background:linear-gradient(135deg,rgba(0,212,170,.1),rgba(59,130,246,.07));
  border:2px solid rgba(0,212,170,.25);border-radius:var(--r);padding:14px
}
.tsc-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--accent);
  letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}
.tsc-total{font-family:'Space Mono',monospace;font-size:24px;font-weight:700;color:var(--accent)}

/* â”€â”€ LOCATION BLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loc-block{
  background:var(--bg);border:1px solid var(--border);border-radius:8px;
  padding:10px;margin-bottom:8px
}
.loc-label{font-size:9px;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;margin-bottom:4px}
.loc-addr{font-size:12px;color:var(--text);font-weight:500}
.loc-town{font-size:11px;color:var(--accent);margin-top:2px;font-family:'Space Mono',monospace}

/* â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.set-row{
  display:flex;justify-content:space-between;align-items:center;
  background:var(--card);border:1px solid var(--border);border-radius:var(--r);
  padding:13px 14px;margin:0 12px 6px
}
.set-label{font-size:13px;font-weight:500}
.set-sub{font-size:11px;color:var(--muted);margin-top:2px}
.set-inp{
  background:var(--bg);border:1.5px solid var(--border);border-radius:8px;
  padding:8px 10px;color:var(--text);font-family:'Space Mono',monospace;
  font-size:15px;font-weight:700;outline:none;width:100px;text-align:right
}
.set-inp:focus{border-color:var(--accent)}
.set-section-title{
  font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);
  letter-spacing:1px;text-transform:uppercase;margin:14px 12px 6px
}

/* â”€â”€ MONTH CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chips{display:flex;gap:6px;overflow-x:auto;padding:10px 12px;scrollbar-width:none}
.chips::-webkit-scrollbar{display:none}
.chip{
  flex-shrink:0;padding:6px 14px;border-radius:99px;font-size:12px;font-weight:600;
  border:1.5px solid var(--border);background:transparent;color:var(--muted);transition:all .15s
}
.chip.on{border-color:var(--accent);color:var(--accent);background:rgba(0,212,170,.08)}

/* â”€â”€ NOTE TOGGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.note-tog{display:flex;align-items:center;gap:5px;color:var(--blue);font-size:12px;font-weight:600;margin-top:6px;cursor:pointer}
.note-area{display:none;margin-top:8px}
.note-area.open{display:block}

/* â”€â”€ ENTRY CARD 2 (Total Gross) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gross-number{font-family:'Space Mono',monospace;font-size:34px;font-weight:700;color:var(--accent)}
.autofill-badge{
  font-size:9px;font-weight:700;letter-spacing:.5px;
  background:rgba(0,212,170,.15);color:var(--accent);
  padding:3px 8px;border-radius:99px;font-family:'Space Mono',monospace
}
.stats-row{display:flex;gap:6px;margin-top:10px;font-size:11px;color:var(--muted)}

/* â”€â”€ DAILY TOTALS CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.dt-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center}
.dt-net-label{font-size:12px;color:var(--muted);margin-bottom:4px}
.dt-net-val{font-family:'Space Mono',monospace;font-size:26px;font-weight:700;color:var(--accent)}

/* â”€â”€ APP INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ai-row{display:flex;justify-content:space-between;padding:5px 0;font-size:12px;border-bottom:1px solid var(--border)}
.ai-row:last-child{border:none}
.ai-key{color:var(--muted)}
.ai-val{font-family:'Space Mono',monospace;color:var(--text)}
</style>
</head>
<body>
<div id="app">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 1 â€” ENTRY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-entry">
  <div class="ph">
    <div class="ph-title">My Drive Log</div>
    <div class="ph-sub" id="entry-sub">Daily Entry</div>
  </div>

  <!-- Card 1: Date / Day / Driving -->
  <div class="card">
    <div class="two-col" style="margin-bottom:12px">
      <div>
        <label class="lbl">Date</label>
        <input type="date" class="inp" id="e-date" style="font-family:'Space Mono',monospace;font-size:13px">
      </div>
      <div>
        <label class="lbl">Day</label>
        <div class="inp" id="e-dow" style="color:var(--muted);font-family:'Space Mono',monospace;font-size:14px;display:flex;align-items:center"></div>
      </div>
    </div>
    <label class="lbl">Driving Today?</label>
    <div class="tog-row">
      <button class="tog on" id="btn-yes" onclick="setDriving(true)">âœ“ Yes</button>
      <button class="tog" id="btn-rest" onclick="setDriving(false)">âœ— Rest Day</button>
    </div>
  </div>

  <!-- DRIVING FIELDS -->
  <div id="e-driving">

    <!-- Card 2: Total Gross from Trip Log -->
    <div class="card" id="e-gross-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">
        <div style="font-size:12px;color:var(--muted)">Total Gross (from Trip Log)</div>
        <span class="autofill-badge" id="e-autofill-badge" style="display:none">AUTO-FILLED</span>
      </div>
      <div class="gross-number" id="e-gross">$0.00</div>

      <!-- Platform boxes â€” always read-only, auto-populated from Trip Log -->
      <div class="plat-grid" style="margin-top:10px">
        <div class="plat-box" style="border-color:rgba(249,115,22,.25)">
          <div class="plat-box-name" style="color:var(--tada)">TADA</div>
          <div class="plat-box-val" id="pb-val-TADA" style="color:var(--muted)">â€”</div>
        </div>
        <div class="plat-box" style="border-color:rgba(0,177,79,.25)">
          <div class="plat-box-name" style="color:var(--grab)">Grab</div>
          <div class="plat-box-val" id="pb-val-Grab" style="color:var(--muted)">â€”</div>
        </div>
        <div class="plat-box" style="border-color:rgba(56,189,248,.25)">
          <div class="plat-box-name" style="color:var(--gojek)">Gojek</div>
          <div class="plat-box-val" id="pb-val-Gojek" style="color:var(--muted)">â€”</div>
        </div>
        <div class="plat-box" style="border-color:rgba(167,139,250,.25)">
          <div class="plat-box-name" style="color:var(--others)">Others</div>
          <div class="plat-box-val" id="pb-val-Others" style="color:var(--muted)">â€”</div>
        </div>
      </div>

      <div class="stats-row" id="e-stats" style="margin-top:10px">No trips yet â€” record trips first</div>
    </div>

    <!-- Card 3: Daily Totals -->
    <div class="card">
      <div class="card-label">Daily Totals</div>
      <div class="dt-grid">
        <div>
          <div class="dt-net-label">Est. Net Today</div>
          <div class="dt-net-val" id="e-net">$0.00</div>
        </div>
        <div>
          <label class="lbl">Petrol Cost ($)</label>
          <input type="number" class="inp" id="e-petrol" placeholder="0.00" step="0.01" min="0"
            style="font-family:'Space Mono',monospace" oninput="updateNet()" autocomplete="off" inputmode="decimal">
        </div>
      </div>
    </div>

    <!-- Card 4: Sessions -->
    <div class="card">
      <div class="card-label">Sessions</div>
      <label class="lbl">Number of Sessions</label>
      <div class="tog-row" style="margin-bottom:0">
        <button class="tog on" id="sc-1" onclick="setSessions(1)">1</button>
        <button class="tog" id="sc-2" onclick="setSessions(2)">2</button>
        <button class="tog" id="sc-3" onclick="setSessions(3)">3</button>
      </div>
      <div id="sess-container"></div>
    </div>

    <!-- Card 5: Daily Notes -->
    <div class="card">
      <div class="card-label">Daily Notes</div>
      <textarea class="inp" id="e-notes" placeholder="e.g. Heavy rain morning, TADA incentive day, good CBD crowd..."></textarea>
    </div>
  </div>

  <!-- REST DAY -->
  <div id="e-rest" style="display:none">
    <div class="card">
      <div style="text-align:center;padding:20px 0 12px">
        <div style="font-size:36px;margin-bottom:8px">ğŸš«</div>
        <div style="color:var(--muted);font-size:14px">Rest Day â€” No driving recorded</div>
      </div>
      <textarea class="inp" id="e-rest-notes" placeholder="Optional notes..."></textarea>
    </div>
  </div>

  <div style="padding:12px 12px 4px">
    <button class="btn btn-green" onclick="saveEntry()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
      Save Entry
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2 â€” SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-summary">
  <div class="mnav">
    <button class="mnav-btn" onclick="changeMonth(-1)">â€¹</button>
    <span class="mnav-title" id="sum-month">FEB 2026</span>
    <button class="mnav-btn" onclick="changeMonth(1)">â€º</button>
  </div>

  <!-- Today banner -->
  <div class="today-banner">
    <div class="tb-cell">
      <div class="tb-label">Today Gross</div>
      <div class="tb-val" id="tb-gross">$0.00</div>
    </div>
    <div class="tb-cell">
      <div class="tb-label">Distance</div>
      <div class="tb-val" id="tb-dist">0 km</div>
    </div>
    <div class="tb-cell">
      <div class="tb-label">Net Today</div>
      <div class="tb-val" id="tb-net">$0.00</div>
    </div>
  </div>

  <div style="height:10px"></div>

  <!-- KPI rows matching your layout exactly -->
  <div class="kpi-row"><span class="kpi-lbl">K1 &middot; Target Monthly Net</span><span class="kpi-val" id="k1">$0</span></div>
  <div class="kpi-row" style="margin-top:6px"><span class="kpi-lbl">K2 &middot; Target Gross Earning</span><span class="kpi-val" id="k2">$0</span></div>
  <div class="kpi-row" style="margin-top:6px"><span class="kpi-lbl">K3 &middot; Total Gross So Far</span><span class="kpi-val" id="k3">$0</span></div>
  <div class="kpi-row" style="margin-top:6px"><span class="kpi-lbl">K4 &middot; Total Petrol So Far</span><span class="kpi-val" id="k4">$0</span></div>
  <div class="kpi-row star-yellow" style="margin-top:6px"><span class="kpi-lbl">â­ K5 &middot; Est. Net So Far</span><span class="kpi-val yellow" id="k5">$0</span></div>
  <div class="kpi-row star-green" style="margin-top:6px"><span class="kpi-lbl">â­ K6 &middot; Remaining Gross Needed</span><span class="kpi-val green" id="k6">$0</span></div>
  <div class="kpi-row" style="margin-top:6px"><span class="kpi-lbl">K7 &middot; Remaining Net Needed</span><span class="kpi-val" id="k7">$0</span></div>
  <div class="kpi-row" style="margin-top:6px"><span class="kpi-lbl">K8 &middot; Req. Avg Gross / Planned Day</span><span class="kpi-val" id="k8">$0</span></div>
  <div class="kpi-row star-amber" style="margin-top:6px"><span class="kpi-lbl">â­ K9 &middot; Balance Gross / Remaining Day</span><span class="kpi-val amber" id="k9">$0</span></div>

  <!-- K10 + K11 side by side -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:6px 12px 0">
    <div class="kpi-row" style="margin:0"><span class="kpi-lbl" style="font-size:12px">K10 &middot; Planned Days</span><span class="kpi-val" id="k10">0</span></div>
    <div class="kpi-row" style="margin:0"><span class="kpi-lbl" style="font-size:12px">K11 &middot; Remaining</span><span class="kpi-val" id="k11">0</span></div>
  </div>
  <div style="height:16px"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3 â€” HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-history">
  <div class="ph"><div class="ph-title">History</div></div>
  <div class="chips" id="hist-chips"></div>
  <div id="hist-list"></div>
  <div style="height:16px"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4 â€” TRIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-trips">
  <div class="ph">
    <div class="ph-title">ğŸ›£ï¸ Trip Log</div>
    <div class="ph-sub" id="trip-sub">Record each trip as you drive</div>
  </div>

  <!-- Active trip -->
  <div id="active-card" style="display:none">
    <div class="active-trip-card">
      <div class="live-badge"><span class="live-dot"></span>TRIP IN PROGRESS</div>
      <div class="timer" id="timer-display">00:00</div>
      <div id="active-plat" style="margin-bottom:8px"></div>
      <div class="loc-block">
        <div class="loc-label">ğŸ“ Pickup</div>
        <div class="loc-addr" id="ap-addr">Capturing...</div>
        <div class="loc-town" id="ap-town"></div>
      </div>
      <button class="btn btn-red" onclick="openEndSheet()" style="margin-top:8px">
        <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
        End Trip
      </button>
      <button class="btn btn-gray" onclick="openCancelConfirm()" style="margin-top:8px;color:var(--danger);border-color:var(--danger)">
        Cancel Trip
      </button>
      <div id="cancel-confirm" style="display:none;margin-top:10px;background:var(--card);border:1px solid var(--danger);border-radius:10px;padding:12px;text-align:center">
        <div style="font-size:13px;color:var(--text);margin-bottom:10px">Discard this trip? It will not be saved.</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-gray" onclick="closeCancelConfirm()" style="flex:1">No â€” Continue</button>
          <button class="btn btn-red" onclick="cancelTrip()" style="flex:1">Confirm Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Today summary -->
  <div id="trip-summary" style="display:none">
    <div class="trip-summary-card">
      <div class="tsc-label">Today's Summary</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span style="font-size:13px;font-weight:600;color:var(--text)" id="trip-count">0 trips</span>
        <span class="tsc-total" id="trip-total">$0.00</span>
      </div>
      <div id="trip-sess-breakdown" style="display:none;font-size:11px;color:var(--muted);margin-bottom:6px;flex-wrap:wrap;gap:8px"></div>
      <div style="font-size:11px;color:var(--muted);display:flex;gap:14px">
        <span id="trip-km">0 km</span><span id="trip-min">0 min</span>
      </div>
    </div>
  </div>

  <div id="trip-list"></div>
  <div style="height:16px"></div>

  <!-- Fixed start button -->
  <button class="start-btn" id="start-btn" onclick="openStartSheet()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="22" height="22">
      <circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8" fill="currentColor" stroke="none"/>
    </svg>
    Start New Trip
  </button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 5 â€” SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-settings">
  <div class="ph"><div class="ph-title">Settings</div><div class="ph-sub" id="set-sub"></div></div>

  <div class="set-section-title">Monthly Targets</div>
  <div class="set-row">
    <div><div class="set-label">Target Monthly Net ($)</div><div class="set-sub">Take-home income goal</div></div>
    <input type="number" class="set-inp" id="s-net" value="7000" oninput="saveSettings()">
  </div>
  <div class="set-row">
    <div><div class="set-label">Planned Driving Days</div><div class="set-sub">Days driving this month</div></div>
    <input type="number" class="set-inp" id="s-days" value="27" oninput="saveSettings()">
  </div>
  <div class="set-row">
    <div><div class="set-label">Est. Petrol / Day ($)</div><div class="set-sub">Average daily petrol spend</div></div>
    <input type="number" class="set-inp" id="s-petrol" value="40" oninput="saveSettings()">
  </div>

  <div class="set-section-title" style="margin-top:18px">App Info</div>
  <div class="card" style="margin-top:0">
    <div class="ai-row"><span class="ai-key">Version</span><span class="ai-val">v3.0.5</span></div>
    <div class="ai-row"><span class="ai-key">Storage</span><span class="ai-val">Local (phone)</span></div>
    <div class="ai-row"><span class="ai-key">Daily Entries</span><span class="ai-val" id="s-entries">0</span></div>
    <div class="ai-row"><span class="ai-key">Trips Recorded</span><span class="ai-val" id="s-trips">0</span></div>
  </div>

  <div class="set-section-title" style="margin-top:18px">Data Export</div>
  <div style="padding:0 12px;display:flex;flex-direction:column;gap:8px">
    <button class="btn btn-outline" onclick="exportDailyCSV()">â¬‡ Export Daily Entries (CSV)</button>
    <button class="btn btn-gray" onclick="exportTripsCSV()">â¬‡ Export Trips (CSV)</button>
    <button class="btn btn-gray" style="color:var(--danger)" onclick="clearMonth()">Clear This Month's Data</button>
  </div>
  <div style="height:20px"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav>
  <button class="nb on" id="nav-entry" onclick="go('entry',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5"/><path d="M17.5 3.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 7.5-7.5z"/></svg>
    Entry
  </button>
  <button class="nb" id="nav-summary" onclick="go('summary',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    Summary
  </button>
  <button class="nb" id="nav-history" onclick="go('history',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg>
    History
  </button>
  <button class="nb" id="nav-trips" onclick="go('trips',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 12h18M3 12l4-4M3 12l4 4M21 12l-4-4M21 12l-4 4"/></svg>
    ğŸ›£ï¸ Trips
  </button>
  <button class="nb" id="nav-settings" onclick="go('settings',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    Settings
  </button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SHEETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- Shift popup -->
<div class="overlay" id="shift-overlay">
  <div class="sheet" style="text-align:center">
    <div class="sheet-handle"></div>
    <div style="font-size:40px;margin-bottom:8px">ğŸš—</div>
    <div class="sheet-title">STARTING YOUR SHIFT?</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.7">
      Good to see you, Kenneth!<br>Are you starting your driving shift today?
    </div>
    <button class="btn btn-green" style="margin-bottom:10px" onclick="startShift()">Yes â€” Start My Shift</button>
    <button class="btn btn-gray" onclick="closeOverlay('shift-overlay')">No â€” Just Checking</button>
  </div>
</div>

<!-- Start trip sheet -->
<div class="overlay" id="start-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">NEW TRIP</div>
    <div style="margin-bottom:12px">
      <label class="lbl">Platform</label>
      <div class="tog-row" id="plat-tog">
        <button class="tog on-tada" onclick="setPlatform('TADA',this)">TADA</button>
        <button class="tog" onclick="setPlatform('Grab',this)">Grab</button>
        <button class="tog" onclick="setPlatform('Gojek',this)">Gojek</button>
        <button class="tog" onclick="setPlatform('Others',this)">Others</button>
      </div>
    </div>
    <div style="margin-bottom:14px">
      <label class="lbl">Mode</label>
      <div class="tog-row" id="mode-tog">
        <button class="tog on" onclick="setMode('Auto',this)">Auto</button>
        <button class="tog" onclick="setMode('Manual',this)">Manual</button>
      </div>
    </div>
    <div style="margin-bottom:14px">
      <label class="lbl">Session</label>
      <div id="sess-auto-label" style="font-size:12px;color:var(--accent);margin-bottom:6px;display:none"></div>
      <div class="tog-row" id="sess-tog">
        <button class="tog on" onclick="setTripSession(1,this)">Session 1</button>
        <button class="tog" onclick="setTripSession(2,this)">Session 2</button>
        <button class="tog" onclick="setTripSession(3,this)">Session 3</button>
      </div>
    </div>
    <div id="start-gps" style="display:none"></div>
    <button class="btn btn-green" id="capture-btn" onclick="captureAndStart()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>
      Capture Pickup &amp; Start Trip
    </button>
    <div style="height:8px"></div>
    <button class="btn btn-gray" onclick="closeOverlay('start-overlay')">Cancel</button>
  </div>
</div>

<!-- End trip sheet -->
<div class="overlay" id="end-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">END TRIP</div>
    <div id="end-gps"></div>
    <div id="end-loc" style="display:none"></div>
    <label class="lbl">Trip Fare ($)</label>
    <div class="fare-wrap">
      <span class="fare-prefix">$</span>
      <input type="number" class="fare-inp" id="fare-inp" placeholder="0.00" step="0.01" min="0"
        autocomplete="off" autocorrect="off" spellcheck="false" inputmode="decimal">
    </div>
    <div class="note-tog" onclick="toggleNote()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add trip note
    </div>
    <div class="note-area" id="note-area">
      <textarea class="inp" id="note-inp" placeholder="Optional trip note..." style="height:60px;margin-top:8px"></textarea>
    </div>
    <div style="height:14px"></div>
    <button class="btn btn-green" onclick="saveTrip()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="16" height="16"><polyline points="20 6 9 17 4 12"/></svg>
      Save Trip
    </button>
    <div style="height:8px"></div>
    <button class="btn btn-gray" onclick="closeOverlay('end-overlay')">Cancel</button>
  </div>
</div>

<!-- Trip detail sheet -->
<div class="overlay" id="detail-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="detail-title">TRIP DETAIL</div>
    <div id="detail-body"></div>
    <div style="height:10px"></div>
    <button class="btn btn-gray" onclick="closeOverlay('detail-overlay')">Close</button>
    <div style="height:8px"></div>
    <button class="btn btn-gray" style="color:var(--danger)" onclick="deleteTrip()">Delete This Trip</button>
  </div>
</div>

<!-- Time prompt overlay -->
<div class="overlay" id="time-prompt-overlay">
  <div class="sheet" style="text-align:center">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="tp-title">START TIME</div>
    <div style="font-size:28px;font-family:'Space Mono',monospace;font-weight:700;color:var(--accent);margin-bottom:6px" id="tp-now-label">Now: 00:00</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:20px">Starting session now?</div>
    <button class="btn btn-green" style="margin-bottom:10px" onclick="timePromptYes()">
      âœ“ Yes â€” Use Current Time
    </button>
    <button class="btn btn-gray" onclick="timePromptNo()">
      âœ No â€” Enter Manually
    </button>
  </div>
</div>

<!-- Hidden time input for manual entry -->
<input type="time" id="hidden-time-inp" style="position:fixed;opacity:0;pointer-events:none;top:0;left:0;width:1px;height:1px">

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MAPS_API_KEY = 'AIzaSyA7NBp93xetd7yUiCyRJNu6X7pFespVR6c';
// Inject Maps JS SDK immediately â€” loads in background while user reads the app
(function(){
  const s=document.createElement('script');
  s.src='https://maps.googleapis.com/maps/api/js?key='+MAPS_API_KEY+'&callback=_mapsCallback';
  s.async=true; s.defer=true;
  document.head.appendChild(s);
})();

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DAYS   = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const SG_HOL = {
  '2026-01-01':"New Year's Day",'2026-01-29':'Chinese New Year',
  '2026-01-30':'Chinese New Year (Day 2)','2026-04-03':'Good Friday',
  '2026-05-01':'Labour Day','2026-05-13':'Vesak Day',
  '2026-06-02':'Hari Raya Haji','2026-08-09':'National Day',
  '2026-10-20':'Deepavali','2026-12-25':'Christmas Day'
};

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isDriving = true, sessCount = 1, sumMonth = new Date();
let histMonth = {y:new Date().getFullYear(), m:new Date().getMonth()};
let activeTrip = null, timerInt = null, tripPlatform = 'TADA', tripMode = 'Auto';
let detailTripId = null;

// â”€â”€ STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DATA_KEY  = 'mdl_data_v305';
const TRIPS_KEY = 'mdl_trips_v305';
const SET_KEY   = (ym) => 'mdl_set_v305_'+ym;

function getData()  { try{return JSON.parse(localStorage.getItem(DATA_KEY)||'{}')}catch{return{}} }
function saveData(d){ localStorage.setItem(DATA_KEY, JSON.stringify(d)) }
function getTrips() { try{return JSON.parse(localStorage.getItem(TRIPS_KEY)||'[]')}catch{return[]} }
function saveTrips(t){ localStorage.setItem(TRIPS_KEY, JSON.stringify(t)) }
function getSettings(ym){
  try{return JSON.parse(localStorage.getItem(SET_KEY(ym))||'{"net":7000,"days":27,"petrol":40}')}
  catch{return{net:7000,days:27,petrol:40}}
}
function putSettings(ym,s){ localStorage.setItem(SET_KEY(ym),JSON.stringify(s)) }

// â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d){
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}
function fmtMoney(v){ return '$'+(Math.abs(v)).toLocaleString('en-SG',{minimumFractionDigits:2,maximumFractionDigits:2}); }

function toast(msg, dur=2200){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
}

// â”€â”€ NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function go(name, btn){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  document.getElementById('screen-'+name).classList.add('active');
  if(btn) btn.classList.add('on');
  if(name==='entry')   initEntry();
  if(name==='summary') renderSummary();
  if(name==='history') renderHistory();
  if(name==='trips')   renderTrips();
  if(name==='settings')initSettings();
}

function closeOverlay(id){ document.getElementById(id).classList.remove('open') }

// â”€â”€ GOOGLE MAPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadGMaps(){
  // Maps JS API is pre-loaded in <head> â€” just wait for callback if not ready yet
  return new Promise(res=>{
    if(window._mapsReady){ res(); return; }
    window._mapsQueue.push(res);
  });
}

function getPos(timeout=10000){
  return new Promise((res,rej)=>{
    if(!navigator.geolocation){rej(new Error('GPS unavailable'));return}
    let done=false;
    const timer=setTimeout(()=>{
      if(!done){done=true;rej(new Error('GPS timeout â€” try again'));}
    },timeout);
    navigator.geolocation.getCurrentPosition(
      pos=>{if(!done){done=true;clearTimeout(timer);res(pos);}},
      err=>{if(!done){done=true;clearTimeout(timer);rej(err);}},
      {enableHighAccuracy:true,timeout:timeout-500,maximumAge:0}
    );
  });
}

async function getPosFallback(){
  // Try high accuracy first, then fall back to low accuracy
  try{ return await getPos(8000); }
  catch{
    try{ return await getPos(8000); } // retry once
    catch{ throw new Error('GPS unavailable â€” check permissions and try again'); }
  }
}

async function reverseGeocode(lat,lng){
  // Uses Google Maps JS SDK (pre-loaded at startup â€” no hang)
  try{
    await loadGMaps();
    const geocoder=new google.maps.Geocoder();
    const result=await new Promise((res,rej)=>{
      geocoder.geocode({location:{lat,lng},region:'SG'},(results,status)=>{
        if(status==='OK'&&results[0]) res(results[0]); else rej(new Error(status));
      });
    });
    const c=result.address_components;
    const postal=(c.find(x=>x.types.includes('postal_code'))||{}).long_name||'';
    const town=
      (c.find(x=>x.types.includes('sublocality_level_1'))||{}).long_name||
      (c.find(x=>x.types.includes('neighborhood'))||{}).long_name||
      (c.find(x=>x.types.includes('sublocality'))||{}).long_name||
      (c.find(x=>x.types.includes('locality'))||{}).long_name||'Singapore';
    const num=(c.find(x=>x.types.includes('street_number'))||{}).long_name||'';
    const route=(c.find(x=>x.types.includes('route'))||{}).long_name||'';
    const premise=(c.find(x=>x.types.includes('premise'))||{}).long_name||'';
    // Deduplicate: if premise already contains the street number, don't add num separately
    const numAlreadyInPremise = num && premise.includes(num);
    const addrParts = numAlreadyInPremise ? [premise,route] : [premise,num,route];
    let addr=addrParts.filter(Boolean).join(' ')||result.formatted_address.split(',')[0];
    if(postal) addr+=' S('+postal+')';
    return{addr,postal,town};
  }catch{
    return{addr:lat.toFixed(5)+', '+lng.toFixed(5),postal:'',town:'Singapore'};
  }
}

function haversine(la1,lo1,la2,lo2){
  const R=6371, dL=(la2-la1)*Math.PI/180, dO=(lo2-lo1)*Math.PI/180;
  const a=Math.sin(dL/2)**2+Math.cos(la1*Math.PI/180)*Math.cos(la2*Math.PI/180)*Math.sin(dO/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

async function getRoadDist(la1,lo1,la2,lo2){
  const straight=haversine(la1,lo1,la2,lo2);
  try{
    await loadGMaps();
    const svc=new google.maps.DistanceMatrixService();
    const r=await new Promise((res,rej)=>{
      svc.getDistanceMatrix({
        origins:[{lat:la1,lng:lo1}],
        destinations:[{lat:la2,lng:lo2}],
        travelMode:google.maps.TravelMode.DRIVING,
        region:'SG'
      },(resp,status)=>{ if(status==='OK') res(resp); else rej(new Error(status)); });
    });
    const m=r.rows?.[0]?.elements?.[0]?.distance?.value;
    if(m&&m>0) return m/1000;
  }catch{}
  return Math.max(straight*1.3,0.1);
}

// â”€â”€ GPS STATUS HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gpsEl(state, text){
  const cls={searching:'search',found:'ok',error:'err'};
  const dot={searching:'dot-warn pulse',found:'dot-ok',error:'dot-err'};
  return `<div class="gps ${cls[state]}"><span class="gps-dot ${dot[state]}"></span><span>${text}</span></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initEntry(){
  const today=fmtDate(new Date());
  const di=document.getElementById('e-date');
  const firstLoad=!di.value;
  if(firstLoad) di.value=today;
  di.max=today; di.min='2026-01-01';
  di.onchange=loadEntry;
  updateDow();
  if(firstLoad){
    loadEntry();
  } else {
    refreshEntryEarnings();
  }
}

function updateDow(){
  const v=document.getElementById('e-date').value;
  if(!v) return;
  const d=new Date(v+'T00:00:00');
  document.getElementById('e-dow').textContent=DAYS[d.getDay()];
  document.getElementById('entry-sub').textContent='Daily Entry â€” '+DAYS[d.getDay()]+', '+v;
}

function setDriving(val){
  isDriving=val;
  document.getElementById('btn-yes').className='tog'+(val?' on':'');
  document.getElementById('btn-rest').className='tog'+(val?'':' on-danger');
  document.getElementById('e-driving').style.display=val?'block':'none';
  document.getElementById('e-rest').style.display=val?'none':'block';
}

function setSessions(n){
  sessCount=n;
  [1,2,3].forEach(i=>{
    document.getElementById('sc-'+i).className='tog'+(i===n?' on':'');
  });
  renderSessions();
  // CRITICAL: Restore session times from sessTimeVals after DOM rebuild
  for(let i=1;i<=3;i++){
    const sv=sessTimeVals[i+'-start'];
    const ev=sessTimeVals[i+'-end'];
    if(sv) setSessionTime(i,'start',sv);
    if(ev) setSessionTime(i,'end',ev);
  }
}

function renderSessions(){
  const c=document.getElementById('sess-container');
  c.innerHTML='';
  const date=document.getElementById('e-date').value||fmtDate(new Date());
  const trips=getTrips().filter(t=>t.date===date);
  const td={TADA:0,Grab:0,Gojek:0,Others:0}; let tkm=0,tmin=0;
  trips.forEach(t=>{td[t.platform]=(td[t.platform]||0)+(t.fare||0);tkm+=t.distanceKm||0;tmin+=t.durationMins||0;});

  const platColors={TADA:'249,115,22',Grab:'0,177,79',Gojek:'56,189,248',Others:'167,139,250'};
  const platVars={TADA:'tada',Grab:'grab',Gojek:'gojek',Others:'others'};

  for(let i=1;i<=sessCount;i++){
    // Platform boxes â€” read-only auto-populated
    const platBoxes=['TADA','Grab','Gojek','Others'].map(p=>`
      <div class="plat-box" style="border-color:rgba(${platColors[p]},.25)">
        <div class="plat-box-name" style="color:var(--${platVars[p]})">${p}</div>
        <div class="plat-box-val" style="color:${td[p]>0?'var(--text)':'var(--muted)'}">${td[p]>0?'$'+td[p].toFixed(2):'â€”'}</div>
      </div>`).join('');

    const statsLine=trips.length>0?
      `<div class="stats-row" style="margin-top:8px">${trips.length} trips &middot; ${tkm.toFixed(1)} km &middot; ${tmin} min</div>`:
      `<div class="stats-row" style="margin-top:8px;color:var(--muted)">No trips recorded yet â€” start trips first</div>`;

    c.innerHTML+=`
    <div class="sess-block">
      <div class="sess-label">Session ${i}</div>
      <div class="two-col" style="margin-bottom:8px">
        <div>
          <label class="lbl">Start Time</label>
          <div class="inp sess-time-btn" id="s-start-${i}" data-sess="${i}" data-type="start"
            onclick="timePrompt(${i},'start')"
            style="cursor:pointer;display:flex;align-items:center;justify-content:space-between;color:var(--muted)">
            <span id="s-start-val-${i}">Tap to set</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          </div>
        </div>
        <div>
          <label class="lbl">End Time</label>
          <div class="inp sess-time-btn" id="s-end-${i}" data-sess="${i}" data-type="end"
            onclick="timePrompt(${i},'end')"
            style="cursor:pointer;display:flex;align-items:center;justify-content:space-between;color:var(--muted)">
            <span id="s-end-val-${i}">Tap to set</span>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
          </div>
        </div>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px" id="s-hrs-${i}"></div>
      <label class="lbl">Platform Earnings (from Trip Log)</label>
      <div class="plat-grid">${platBoxes}</div>
      ${statsLine}
    </div>`;
  }
}

// Session time values stored separately
const sessTimeVals = {};

function timePrompt(sess, type){
  const key=`${sess}-${type}`;
  const now=new Date();
  const nowStr=String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');

  // Show mini prompt overlay
  const overlay=document.getElementById('time-prompt-overlay');
  document.getElementById('tp-title').textContent=(type==='start'?'Start':'End')+' Time â€” Session '+sess;
  document.getElementById('tp-now-label').textContent='Now: '+nowStr;
  overlay.classList.add('open');

  // Store pending action
  overlay._sess=sess; overlay._type=type; overlay._nowStr=nowStr;
}

function timePromptYes(){
  const overlay=document.getElementById('time-prompt-overlay');
  const{_sess,_type,_nowStr}=overlay;
  setSessionTime(_sess,_type,_nowStr);
  overlay.classList.remove('open');
}

function timePromptNo(){
  const overlay=document.getElementById('time-prompt-overlay');
  const{_sess,_type}=overlay;
  overlay.classList.remove('open');
  // Open native time picker via hidden input
  const hid=document.getElementById('hidden-time-inp');
  hid.value=sessTimeVals[`${_sess}-${_type}`]||'';
  hid._sess=_sess; hid._type=_type;
  hid.onchange=()=>{
    if(hid.value) setSessionTime(hid._sess,hid._type,hid.value);
    hid.value='';
  };
  hid.click();
}

function setSessionTime(sess,type,val){
  const key=`${sess}-${type}`;
  sessTimeVals[key]=val;
  const el=document.getElementById(`s-${type}-val-${sess}`);
  const wrap=document.getElementById(`s-${type}-${sess}`);
  if(el){ el.textContent=val; el.style.color='var(--text)'; }
  if(wrap) wrap.style.color='var(--text)';
  calcHrs(sess);
}

function calcHrs(i){
  const s=sessTimeVals[`${i}-start`];
  const e=sessTimeVals[`${i}-end`];
  const el=document.getElementById('s-hrs-'+i);
  if(!s||!e||!el) return;
  const [sh,sm]=s.split(':').map(Number), [eh,em]=e.split(':').map(Number);
  let mins=(eh*60+em)-(sh*60+sm); if(mins<0) mins+=1440;
  el.textContent=`Duration: ${Math.floor(mins/60)}h ${mins%60}m`;
}

function loadEntry(){
  updateDow();
  const date=document.getElementById('e-date').value; if(!date) return;
  const data=getData(), entry=data[date];
  const trips=getTrips().filter(t=>t.date===date);

  // Always auto-populate platform boxes from Trip Log â€” no manual input
  const td={TADA:0,Grab:0,Gojek:0,Others:0};
  let totalFare=0, totalKm=0, totalMin=0;
  trips.forEach(t=>{
    td[t.platform]=(td[t.platform]||0)+(t.fare||0);
    totalFare+=t.fare||0; totalKm+=t.distanceKm||0; totalMin+=t.durationMins||0;
  });

  document.getElementById('e-gross').textContent=fmtMoney(totalFare);
  document.getElementById('e-autofill-badge').style.display=trips.length>0?'inline-flex':'none';

  // Update each read-only platform box
  ['TADA','Grab','Gojek','Others'].forEach(p=>{
    const el=document.getElementById('pb-val-'+p);
    if(!el) return;
    if(td[p]>0){ el.textContent='$'+td[p].toFixed(2); el.style.color='var(--text)'; }
    else        { el.textContent='â€”';                  el.style.color='var(--muted)'; }
  });

  const statsEl=document.getElementById('e-stats');
  if(statsEl){
    if(trips.length>0){
      const hrs=Math.floor(totalMin/60), mins=totalMin%60;
      statsEl.textContent=trips.length+' trips Â· '+totalKm.toFixed(1)+' km Â· '+hrs+'h '+mins+'m';
    } else {
      statsEl.textContent='No trips yet â€” record trips first';
    }
  }
  updateNetDisplay(totalFare);

  if(entry){
    setDriving(entry.driving!==false);
    if(entry.driving!==false){
      // Find max sessions: saved entry OR unsaved sessTimeVals (keep whichever is higher)
      const savedCount = entry.sessions?.length||1;
      let unsavedMax = 0;
      for(let i=1; i<=3; i++){ if(sessTimeVals[`${i}-start`]) unsavedMax=i; }
      const totalCount = Math.max(savedCount, unsavedMax);
      // Populate sessTimeVals from saved entry (don't overwrite unsaved data for higher sessions)
      entry.sessions?.forEach((s,i)=>{
        if(s.start) sessTimeVals[(i+1)+'-start']=s.start;
        if(s.end)   sessTimeVals[(i+1)+'-end']=s.end;
      });
      // Render with correct total count â€” setSessions restores all sessTimeVals
      setSessions(totalCount);
      document.getElementById('e-petrol').value=entry.petrol||'';
      document.getElementById('e-notes').value=entry.notes||'';
    } else {
      document.getElementById('e-rest-notes').value=entry.notes||'';
    }
    updateNet();
  } else {
    document.getElementById('e-petrol').value='';
    document.getElementById('e-notes').value='';
    setDriving(true);
    // Restore session count from sessTimeVals if data exists (not yet saved to localStorage)
    let maxSess = 0;
    for(let i=1; i<=3; i++){ if(sessTimeVals[`${i}-start`]) maxSess=i; }
    setSessions(maxSess>0 ? maxSess : 1);
    if(maxSess>0){
      for(let i=1; i<=maxSess; i++){
        if(sessTimeVals[`${i}-start`]) setSessionTime(i,'start',sessTimeVals[`${i}-start`]);
        if(sessTimeVals[`${i}-end`])   setSessionTime(i,'end',  sessTimeVals[`${i}-end`]);
      }
    }
  }
}

function refreshEntryEarnings(){
  // Refresh earnings/platform boxes only â€” do NOT touch session state
  const date=document.getElementById('e-date').value;
  if(!date) return;
  const trips=getTrips().filter(t=>t.date===date);
  const td={TADA:0,Grab:0,Gojek:0,Others:0};
  let totalFare=0,totalKm=0,totalMin=0;
  trips.forEach(t=>{
    td[t.platform]=(td[t.platform]||0)+(t.fare||0);
    totalFare+=t.fare||0; totalKm+=t.distanceKm||0; totalMin+=t.durationMins||0;
  });
  document.getElementById('e-gross').textContent=fmtMoney(totalFare);
  document.getElementById('e-autofill-badge').style.display=trips.length>0?'inline-flex':'none';
  ['TADA','Grab','Gojek','Others'].forEach(p=>{
    const el=document.getElementById('pb-val-'+p);
    if(!el) return;
    if(td[p]>0){ el.textContent='$'+td[p].toFixed(2); el.style.color='var(--text)'; }
    else        { el.textContent='â€”'; el.style.color='var(--muted)'; }
  });
  const statsEl=document.getElementById('e-stats');
  if(statsEl){
    if(trips.length>0){
      const hrs=Math.floor(totalMin/60),mins=totalMin%60;
      statsEl.textContent=trips.length+' trips Â· '+totalKm.toFixed(1)+' km Â· '+hrs+'h '+mins+'m';
    } else { statsEl.textContent='No trips yet â€” start trips first'; }
  }
  updateNetDisplay(totalFare);
  // Also refresh session platform boxes without rebuilding DOM
  renderSessions();
}

function updateNet(){
  const grossText=document.getElementById('e-gross').textContent.replace(/[$,]/g,'');
  const gross=parseFloat(grossText)||0;
  updateNetDisplay(gross);
}

function updateNetDisplay(gross){
  const petrol=parseFloat(document.getElementById('e-petrol')?.value)||0;
  document.getElementById('e-net').textContent=fmtMoney(gross-petrol);
}

function saveEntry(){
  const date=document.getElementById('e-date').value;
  if(!date){toast('Please select a date');return;}
  const data=getData();
  const d=new Date(date+'T00:00:00');
  const dow=DAYS[d.getDay()];
  const isHol=!!SG_HOL[date];

  if(!isDriving){
    data[date]={date,dayOfWeek:dow,driving:false,notes:document.getElementById('e-rest-notes').value,isHoliday:isHol,holidayName:SG_HOL[date]||''};
    saveData(data); toast('Rest day saved âœ“');
    setTimeout(()=>go('summary',document.getElementById('nav-summary')),900);
    return;
  }

  const trips=getTrips().filter(t=>t.date===date);
  let earnings={tada:0,grab:0,gojek:0,others:0,total:0};
  let distance=0;

  if(trips.length>0){
    trips.forEach(t=>{
      const p=(t.platform||'').toLowerCase();
      if(p==='tada') earnings.tada+=t.fare||0;
      else if(p==='grab') earnings.grab+=t.fare||0;
      else if(p==='gojek') earnings.gojek+=t.fare||0;
      else earnings.others+=t.fare||0;
      distance+=t.distanceKm||0;
    });
    earnings.total=earnings.tada+earnings.grab+earnings.gojek+earnings.others;
  } else {
    // No trips recorded â€” earnings remain 0 (no manual input)
    earnings.total=0;
  }

  const petrol=parseFloat(document.getElementById('e-petrol').value)||0;
  const sessions=[];
  for(let i=1;i<=sessCount;i++){
    const start=sessTimeVals[`${i}-start`]||'';
    const end=sessTimeVals[`${i}-end`]||'';
    const [sh,sm]=start?start.split(':').map(Number):[0,0];
    const [eh,em]=end?end.split(':').map(Number):[0,0];
    let mins=(eh*60+em)-(sh*60+sm); if(mins<0) mins+=1440;
    sessions.push({start,end,hours:(mins/60).toFixed(1)});
  }

  data[date]={
    date,dayOfWeek:dow,driving:true,sessions,earnings,
    petrol,distance:parseFloat(distance.toFixed(1)),
    estNet:earnings.total-petrol,
    notes:document.getElementById('e-notes').value,
    isHoliday:isHol,holidayName:SG_HOL[date]||''
  };
  saveData(data); toast('Entry saved âœ“');
  setTimeout(()=>go('summary',document.getElementById('nav-summary')),900);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function changeMonth(dir){
  sumMonth=new Date(sumMonth.getFullYear(),sumMonth.getMonth()+dir,1);
  renderSummary();
}

function renderSummary(){
  const y=sumMonth.getFullYear(), mo=sumMonth.getMonth();
  document.getElementById('sum-month').textContent=MONTHS[mo].toUpperCase()+' '+y;
  const ym=y+'_'+(mo+1);
  const s=getSettings(ym);
  const data=getData();
  const today=fmtDate(new Date());
  const te=data[today];

  document.getElementById('tb-gross').textContent=fmtMoney(te?.earnings?.total||0);
  document.getElementById('tb-dist').textContent=(te?.distance||0)+' km';
  document.getElementById('tb-net').textContent=fmtMoney(te?.estNet||0);

  const prefix=y+'-'+String(mo+1).padStart(2,'0')+'-';
  const entries=Object.values(data).filter(e=>e.date?.startsWith(prefix));
  const k3=entries.reduce((a,e)=>a+(e.earnings?.total||0),0);
  const k4=entries.reduce((a,e)=>a+(e.petrol||0),0);
  const driven=entries.filter(e=>e.driving&&(e.earnings?.total||0)>0).length;
  const rem=Math.max(0,s.days-driven);

  const k1=s.net, k2=k1+s.days*s.petrol;
  const k5=k3-k4, k6=Math.max(0,k2-k3), k7=Math.max(0,k1-k5);
  const k8=k2/Math.max(1,s.days), k9=k6/Math.max(1,rem);

  const fm=v=>fmtMoney(v);
  document.getElementById('k1').textContent=fm(k1);
  document.getElementById('k2').textContent=fm(k2);
  document.getElementById('k3').textContent=fm(k3);
  document.getElementById('k4').textContent=fm(k4);
  document.getElementById('k5').textContent=fm(k5);
  document.getElementById('k6').textContent=fm(k6);
  document.getElementById('k7').textContent=fm(k7);
  document.getElementById('k8').textContent=fm(k8);
  document.getElementById('k9').textContent=fm(k9);
  document.getElementById('k10').textContent=s.days;
  document.getElementById('k11').textContent=rem;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistory(){
  const chips=document.getElementById('hist-chips');
  chips.innerHTML='';
  const now=new Date();
  const data=getData();
  const trips=getTrips();
  let cur=new Date(2026,0,1);
  while(cur<=now){
    const y=cur.getFullYear(),m=cur.getMonth();
    const prefix=y+'-'+String(m+1).padStart(2,'0')+'-';
    const isCurrentMonth=(y===now.getFullYear()&&m===now.getMonth());
    const hasData=Object.keys(data).some(k=>k.startsWith(prefix))||trips.some(t=>t.date.startsWith(prefix));
    if(hasData||isCurrentMonth){
      const on=(y===histMonth.y&&m===histMonth.m)?'on':'';
      chips.innerHTML+=`<button class="chip ${on}" onclick="setHistMonth(${y},${m})">${MONTHS[m]} ${y}</button>`;
    }
    cur=new Date(y,m+1,1);
  }
  renderHistList();
}

function setHistMonth(y,m){ histMonth={y,m}; renderHistory(); }

function renderHistList(){
  const{y,m}=histMonth;
  const prefix=y+'-'+String(m+1).padStart(2,'0')+'-';
  const data=getData(), daysInMonth=new Date(y,m+1,0).getDate();
  const list=document.getElementById('hist-list');
  list.innerHTML='';
  let any=false;
  for(let d=daysInMonth;d>=1;d--){
    const ds=prefix+String(d).padStart(2,'0');
    const e=data[ds];
    const isHol=!!SG_HOL[ds];
    if(!e&&!isHol) continue;
    any=true;
    const dow=DAYS[new Date(ds+'T00:00:00').getDay()];
    const gross=e?.earnings?.total||0, net=e?.estNet||0;
    const tag=e?.driving===false?
      (isHol?`<span style="font-size:10px;color:var(--warn)">ğŸ‰ ${SG_HOL[ds]}</span>`:`<span style="font-size:10px;color:var(--danger)">ğŸš« Rest</span>`):
      `<span style="font-size:10px;color:var(--accent)">ğŸŸ¢ Driving</span>`;

    const platHtml=e?.driving?(['TADA','Grab','Gojek','Others'].filter(p=>(e.earnings?.[p.toLowerCase()]||0)>0)
      .map(p=>`<span class="ppill ppill-${p}">${p}</span>`).join('')):'';

    // Trip stats from trip log
    const dayTrips=getTrips().filter(t=>t.date===ds);
    const tripCount=dayTrips.length;
    const tripKm=dayTrips.reduce((a,t)=>a+(t.distanceKm||0),0);
    const tripMin=dayTrips.reduce((a,t)=>a+(t.durationMins||0),0);
    const tripHrs=Math.floor(tripMin/60), tripMins=tripMin%60;

    list.innerHTML+=`
    <div class="hist-card">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
        <div>
          <div style="font-family:'Space Mono',monospace;font-size:12px;font-weight:700">${dow}, ${String(d).padStart(2,'0')} ${MONTHS[m]}</div>
          <div style="margin-top:3px">${tag} ${platHtml}</div>
        </div>
        <div style="text-align:right">
          <div style="font-family:'Space Mono',monospace;font-size:14px;font-weight:700">${fmtMoney(gross)}</div>
          <div style="font-size:11px;color:var(--muted)">Gross Earning</div>
        </div>
      </div>
      ${tripCount>0?`<div style="font-size:11px;color:var(--muted);display:flex;gap:12px;margin-bottom:4px">
        <span>ğŸš— ${tripCount} trip${tripCount!==1?'s':''}</span>
        <span>ğŸ“ ${tripKm.toFixed(1)} km</span>
        <span>â± ${tripHrs>0?tripHrs+'h ':''} ${tripMins}min</span>
      </div>`:''}
      ${e?.notes?`<div style="font-size:11px;color:var(--muted);margin-top:4px;font-style:italic">"${e.notes}"</div>`:''}
    </div>`;
  }
  if(!any) list.innerHTML=`<div class="empty">No entries for ${MONTHS[m]} ${y}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTrips(){
  const today=fmtDate(new Date());
  const trips=getTrips().filter(t=>t.date===today);
  const btn=document.getElementById('start-btn');
  const ac=document.getElementById('active-card');

  document.getElementById('trip-sub').textContent=today+' Â· '+trips.length+' trip'+(trips.length!==1?'s':'')+' recorded';

  if(activeTrip){
    btn.disabled=true; ac.style.display='block';
    document.getElementById('ap-addr').textContent=activeTrip.pickup?.addr||'Captured';
    document.getElementById('ap-town').textContent=activeTrip.pickup?.town||'';
    const pc={'TADA':'tada','Grab':'grab','Gojek':'gojek','Others':'others'};
    document.getElementById('active-plat').innerHTML=
      `<span class="ppill ppill-${activeTrip.platform}">${activeTrip.platform}</span>
       <span style="font-size:11px;color:var(--muted);margin-left:8px">${activeTrip.mode}</span>`;
  } else {
    btn.disabled=false; ac.style.display='none';
  }

  const ts=document.getElementById('trip-summary');
  if(trips.length>0){
    const tf=trips.reduce((a,t)=>a+(t.fare||0),0);
    const tk=trips.reduce((a,t)=>a+(t.distanceKm||0),0);
    const tm=trips.reduce((a,t)=>a+(t.durationMins||0),0);
    ts.style.display='block';
    document.getElementById('trip-count').textContent=trips.length+' trip'+(trips.length!==1?'s':'')+' today';
    document.getElementById('trip-total').textContent=fmtMoney(tf);
    document.getElementById('trip-km').textContent=tk.toFixed(1)+' km';
    document.getElementById('trip-min').textContent=tm+' min';
    // Session breakdown â€” always show
    const sessFares={};
    trips.forEach(t=>{ const s=t.sessionNum||1; sessFares[s]=(sessFares[s]||0)+(t.fare||0); });
    const sessKeys=Object.keys(sessFares).sort();
    const sessEl=document.getElementById('trip-sess-breakdown');
    if(sessEl){
      sessEl.style.display='flex';
      sessEl.innerHTML=sessKeys.map(s=>`<span>Sess ${s}: ${fmtMoney(sessFares[s])}</span>`).join('<span style="color:var(--border)"> | </span>');
    }
  } else { ts.style.display='none'; }

  const list=document.getElementById('trip-list');
  if(trips.length===0&&!activeTrip){
    list.innerHTML=`<div class="empty">No trips today.<br>Tap Start New Trip when your passenger gets in.</div>`;
    return;
  }
  list.innerHTML=[...trips].reverse().map((t,i)=>`
  <div class="trip-card" onclick="showDetail('${t.id}')">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="font-size:10px;color:var(--muted);margin-bottom:2px">Trip #${trips.length-i} &middot; Sess ${t.sessionNum||1}</div>
        <div style="display:flex;gap:6px;align-items:center">
          <span class="ppill ppill-${t.platform}">${t.platform}</span>
          <span style="font-size:10px;color:var(--muted)">${t.mode}</span>
        </div>
      </div>
      <div class="trip-fare">&#36;${(t.fare||0).toFixed(2)}</div>
    </div>
    <div style="font-size:11px;color:var(--accent);font-family:'Space Mono',monospace;margin:4px 0 2px">${t.startTime||''}${t.endTime?' ~ '+t.endTime:''}</div>
    <div class="trip-route">${t.pickup?.town||'â€”'} &rarr; ${t.dropoff?.town||'â€”'}</div>
    <div class="trip-meta" style="justify-content:flex-end">
      <span>${(t.distanceKm||0).toFixed(1)} km</span>
      <span>${t.durationMins||0} min</span>
      <span>${t.distanceKm>0.1?'&#36;'+(t.fare/t.distanceKm).toFixed(2)+'/km':'â€”'}</span>
    </div>
    ${t.note?`<div style="font-size:11px;color:var(--muted);margin-top:5px;font-style:italic">"${t.note}"</div>`:''}
  </div>`).join('');
}

// â”€â”€ Trip detail â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(id){
  const t=getTrips().find(x=>String(x.id)===String(id));
  if(!t) return;
  detailTripId=id;
  const allToday=getTrips().filter(x=>x.date===t.date);
  const num=allToday.findIndex(x=>String(x.id)===String(id))+1;
  document.getElementById('detail-title').textContent='TRIP #'+num+' â€” '+t.date;
  const perKm=t.distanceKm>0.1?fmtMoney(t.fare/t.distanceKm)+'/km':'â€”';
  document.getElementById('detail-body').innerHTML=`
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-family:'Space Mono',monospace;font-size:38px;font-weight:700;color:var(--accent)">&#36;${(t.fare||0).toFixed(2)}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px">${perKm}</div>
    </div>
    <div style="display:flex;gap:6px;justify-content:center;margin-bottom:14px">
      <span class="ppill ppill-${t.platform}">${t.platform}</span>
      <span style="font-size:11px;color:var(--muted);display:flex;align-items:center">${t.mode}</span>
    </div>
    <div style="margin-bottom:10px">
      <div style="font-size:10px;color:var(--blue);font-weight:600;margin-bottom:2px">ğŸ“ Pick up</div>
      <div style="font-size:13px;color:var(--text)">${t.pickup?.addr||'â€”'}</div>
      <div style="font-size:11px;color:var(--accent)">${t.pickup?.town||''}</div>
    </div>
    <div style="margin-bottom:14px">
      <div style="font-size:10px;color:var(--blue);font-weight:600;margin-bottom:2px">ğŸ Drop off</div>
      <div style="font-size:13px;color:var(--text)">${t.dropoff?.addr||'â€”'}</div>
      <div style="font-size:11px;color:var(--accent)">${t.dropoff?.town||''}</div>
    </div>
    <div style="display:flex;gap:20px;font-size:12px;color:var(--muted);margin-bottom:14px;padding:10px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border)">
      <div><span style="color:var(--text);font-family:'Space Mono',monospace;font-size:13px;font-weight:700">${t.startTime||''}${t.endTime?' ~ '+t.endTime:''}</span><br>Time</div>
      <div><span style="color:var(--text);font-family:'Space Mono',monospace;font-size:13px;font-weight:700">${(t.distanceKm||0).toFixed(1)} km</span><br>Distance</div>
      <div><span style="color:var(--text);font-family:'Space Mono',monospace;font-size:13px;font-weight:700">${t.durationMins||0} min</span><br>Duration</div>
    </div>
    ${t.note?`<div style="font-size:12px;color:var(--muted);font-style:italic;padding:8px 0">"${t.note}"</div>`:''}`;
  document.getElementById('detail-overlay').classList.add('open');
}

function deleteTrip(){
  if(!confirm('Delete this trip?')) return;
  let trips=getTrips();
  const t=trips.find(x=>String(x.id)===String(detailTripId));
  trips=trips.filter(x=>String(x.id)!==String(detailTripId));
  saveTrips(trips);
  if(t) syncDailyEntry(t.date);
  closeOverlay('detail-overlay'); renderTrips(); toast('Trip deleted');
}

// â”€â”€ Start/End trip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setPlatform(p,btn){
  tripPlatform=p;
  const map={TADA:'on-tada',Grab:'on-grab',Gojek:'on-gojek',Others:'on-others'};
  document.querySelectorAll('#plat-tog .tog').forEach(b=>b.className='tog');
  btn.className='tog '+map[p];
}

function setMode(m,btn){
  tripMode=m;
  document.querySelectorAll('#mode-tog .tog').forEach(b=>b.className='tog');
  btn.className='tog on';
}

let tripSession = 1;

function setTripSession(n, btn){
  tripSession = n;
  document.querySelectorAll('#sess-tog .tog').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}

function autoDetectSession(){
  const toMins = t => { if(!t) return -1; const [h,m]=t.split(':').map(Number); return h*60+m; };
  const nowMins = toMins(new Date().toTimeString().slice(0,5));
  let detected = 0;
  for(let i=1; i<=3; i++){
    const start = toMins(sessTimeVals[`${i}-start`]||'');
    const end = toMins(sessTimeVals[`${i}-end`]||'');
    if(start >= 0 && nowMins >= start && (end < 0 || nowMins <= end)){
      detected = i;
    }
  }
  // Fallback: check saved localStorage entry if sessTimeVals empty
  if(!detected){
    const today = fmtDate(new Date());
    const sessions = getData()[today]?.sessions || [];
    sessions.forEach((s,i) => {
      const start = toMins(s.start);
      const end = toMins(s.end);
      if(start >= 0 && nowMins >= start && (end < 0 || nowMins <= end)) detected = i+1;
    });
  }
  return detected;
}

function openStartSheet(){
  document.getElementById('start-gps').style.display='none';
  // Default to highest session that has a start time entered
  let defaultSess = 1;
  for(let i=1; i<=3; i++){ if(sessTimeVals[`${i}-start`]) defaultSess=i; }
  tripSession = defaultSess;
  const label = document.getElementById('sess-auto-label');
  label.style.display='none';
  document.querySelectorAll('#sess-tog .tog').forEach((b,i)=>{
    b.classList.toggle('on', i+1 === defaultSess);
  });
  document.getElementById('start-overlay').classList.add('open');
}

async function captureAndStart(){
  const btn=document.getElementById('capture-btn');
  btn.disabled=true; btn.textContent='Getting GPS...';
  const gps=document.getElementById('start-gps');
  gps.style.display='block';
  gps.innerHTML=gpsEl('searching','Getting GPS position...');

  let pos;
  try{
    // Step 1: Get raw GPS position FIRST (no Maps needed)
    pos=await getPosFallback();
    gps.innerHTML=gpsEl('searching','GPS found â€” getting address...');
  }catch(e){
    gps.innerHTML=gpsEl('error',e.message||'GPS failed â€” ensure Location is ON, then retry');
    btn.disabled=false; btn.textContent='Capture Pickup & Start Trip';
    return;
  }

  const{latitude:lat,longitude:lng}=pos.coords;

  // Step 2: Reverse geocode (Maps API â€” may already be loaded from startup)
  let loc;
  try{
    loc=await reverseGeocode(lat,lng);
  }catch(e){
    // If Maps fails, use raw coords â€” don't block the trip
    loc={addr:`${lat.toFixed(5)}, ${lng.toFixed(5)}`,postal:'',town:'(address unavailable)'};
  }

  gps.innerHTML=gpsEl('found',`${loc.addr} â€” ${loc.town}`);
  activeTrip={
    id:Date.now(), date:fmtDate(new Date()), platform:tripPlatform, mode:tripMode,
    startTime:new Date().toTimeString().slice(0,5), startTs:Date.now(),
    sessionNum: tripSession,
    pickup:{lat,lng,...loc}
  };
  startTimer();
  btn.disabled=false; btn.textContent='Capture Pickup & Start Trip';
  setTimeout(()=>{ closeOverlay('start-overlay'); renderTrips(); toast('Trip started! ğŸš—'); },700);
}

function startTimer(){
  if(timerInt) clearInterval(timerInt);
  timerInt=setInterval(()=>{
    if(!activeTrip){clearInterval(timerInt);return}
    const s=Math.floor((Date.now()-activeTrip.startTs)/1000);
    const el=document.getElementById('timer-display');
    if(el) el.textContent=String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
  },1000);
}

async function openEndSheet(){
  document.getElementById('end-overlay').classList.add('open');
  document.getElementById('fare-inp').value='';
  document.getElementById('note-inp').value='';
  document.getElementById('note-area').classList.remove('open');
  const gps=document.getElementById('end-gps');
  const loc=document.getElementById('end-loc');
  gps.innerHTML=gpsEl('searching','Capturing dropoff location...');
  gps.style.display='block'; loc.style.display='none';
  try{
    const pos=await getPosFallback();
    const{latitude:lat,longitude:lng}=pos.coords;
    gps.innerHTML=gpsEl('searching','Getting address & road distance...');
    const[location,dist]=await Promise.all([
      reverseGeocode(lat,lng),
      getRoadDist(activeTrip.pickup.lat,activeTrip.pickup.lng,lat,lng)
    ]);
    const durMin=Math.round((Date.now()-activeTrip.startTs)/60000);
    activeTrip._drop={lat,lng,...location};
    activeTrip._dist=dist; activeTrip._dur=durMin;
    gps.style.display='none'; loc.style.display='block';
    loc.innerHTML=`
      <div class="loc-block"><div class="loc-label">ğŸ“ Pickup</div>
        <div class="loc-addr">${activeTrip.pickup.addr}</div>
        <div class="loc-town">${activeTrip.pickup.town}</div></div>
      <div class="loc-block"><div class="loc-label">ğŸ Dropoff</div>
        <div class="loc-addr">${location.addr}</div>
        <div class="loc-town">${location.town}</div></div>
      <div style="display:flex;gap:14px;font-size:12px;color:var(--muted);background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:12px">
        <span>ğŸ“ ${dist.toFixed(1)} km</span><span>â± ${durMin} min</span></div>`;
    setTimeout(()=>document.getElementById('fare-inp').focus(),200);
  }catch{
    gps.innerHTML=gpsEl('error','GPS failed â€” distance will be 0');
    activeTrip._drop=null; activeTrip._dist=0;
    activeTrip._dur=Math.round((Date.now()-activeTrip.startTs)/60000);
  }
}

function openCancelConfirm(){
  document.getElementById('cancel-confirm').style.display='block';
}
function closeCancelConfirm(){
  document.getElementById('cancel-confirm').style.display='none';
}
function cancelTrip(){
  clearInterval(timerInt); timerInt=null;
  activeTrip=null; sessionStorage.removeItem('mdl_active');
  document.getElementById('cancel-confirm').style.display='none';
  document.getElementById('active-card').style.display='none';
  closeOverlay('end-overlay');
  go('trips', document.getElementById('nav-trips'));
  toast('Trip cancelled â€” not saved');
}

function toggleNote(){ document.getElementById('note-area').classList.toggle('open'); }

function saveTrip(){
  const fare=parseFloat(document.getElementById('fare-inp').value)||0;
  if(fare<=0){toast('Please enter the trip fare');return;}
  const trip={
    id:activeTrip.id, date:activeTrip.date, platform:activeTrip.platform,
    mode:activeTrip.mode, startTime:activeTrip.startTime,
    endTime:new Date().toTimeString().slice(0,5),
    sessionNum: activeTrip.sessionNum||1,
    startTs:activeTrip.startTs, endTs:Date.now(),
    durationMins:activeTrip._dur||Math.round((Date.now()-activeTrip.startTs)/60000),
    pickup:activeTrip.pickup,
    dropoff:activeTrip._drop||{addr:'â€”',town:'â€”',postal:'',lat:0,lng:0},
    distanceKm:parseFloat((activeTrip._dist||0).toFixed(2)),
    fare, note:document.getElementById('note-inp').value
  };
  const trips=getTrips(); trips.push(trip); saveTrips(trips);
  clearInterval(timerInt); timerInt=null;
  activeTrip=null; sessionStorage.removeItem('mdl_active');
  closeOverlay('end-overlay');
  syncDailyEntry(trip.date);
  toast('Trip saved! $'+fare.toFixed(2)+' âœ“');
  setTimeout(()=>renderTrips(),300);
}

function syncDailyEntry(date){
  const trips=getTrips().filter(t=>t.date===date);
  const data=getData(), entry=data[date]||{};
  const e={tada:0,grab:0,gojek:0,others:0}; let km=0;
  trips.forEach(t=>{
    const p=(t.platform||'').toLowerCase();
    e[p in e?p:'others']+=t.fare||0; km+=t.distanceKm||0;
  });
  e.total=e.tada+e.grab+e.gojek+e.others;
  const d=new Date(date+'T00:00:00');
  data[date]={...entry,date,dayOfWeek:DAYS[d.getDay()],driving:true,
    earnings:e,distance:parseFloat(km.toFixed(1)),estNet:e.total-(entry.petrol||0)};
  saveData(data);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initSettings(){
  const now=new Date(), ym=now.getFullYear()+'_'+(now.getMonth()+1);
  document.getElementById('set-sub').textContent='Settings for '+MONTHS[now.getMonth()]+' '+now.getFullYear();
  const s=getSettings(ym);
  document.getElementById('s-net').value=s.net;
  document.getElementById('s-days').value=s.days;
  document.getElementById('s-petrol').value=s.petrol;
  document.getElementById('s-entries').textContent=Object.keys(getData()).length;
  document.getElementById('s-trips').textContent=getTrips().length;
}

function saveSettings(){
  const now=new Date(), ym=now.getFullYear()+'_'+(now.getMonth()+1);
  putSettings(ym,{
    net:parseFloat(document.getElementById('s-net').value)||7000,
    days:parseInt(document.getElementById('s-days').value)||27,
    petrol:parseFloat(document.getElementById('s-petrol').value)||40
  });
  toast('Settings saved âœ“');
}

function clearMonth(){
  const{y,m}=histMonth;
  const label=MONTHS[m]+' '+y;
  if(!confirm('Clear all entries for '+label+'?')) return;
  const prefix=y+'-'+String(m+1).padStart(2,'0')+'-';
  const data=getData();
  Object.keys(data).filter(k=>k.startsWith(prefix)).forEach(k=>delete data[k]);
  // Also clear trips for that month
  const trips=getTrips().filter(t=>!t.date.startsWith(prefix));
  saveTrips(trips);
  saveData(data);
  toast(label+' data cleared');
  renderHistory();
}

function exportDailyCSV(){
  const data=getData();
  const rows=[['Date','Day','Driving','TADA','Grab','Gojek','Others','Total Gross','Petrol','Est Net','Distance km','Notes']];
  Object.values(data).sort((a,b)=>a.date.localeCompare(b.date)).forEach(e=>{
    rows.push([e.date,e.dayOfWeek,e.driving?'Y':'N',
      e.earnings?.tada||0,e.earnings?.grab||0,e.earnings?.gojek||0,e.earnings?.others||0,
      e.earnings?.total||0,e.petrol||0,e.estNet||0,e.distance||0,e.notes||'']);
  });
  dlCSV(rows,'MyDriveLog_Daily_'+fmtDate(new Date())+'.csv');
}

function exportTripsCSV(){
  const trips=getTrips();
  const rows=[['Date','Start','End','Platform','Mode','Pickup Town','Pickup Addr','Dropoff Town','Dropoff Addr','Distance km','Duration min','Fare','$/km','Note']];
  trips.forEach(t=>{
    const perKm=t.distanceKm>0?(t.fare/t.distanceKm).toFixed(2):'â€”';
    rows.push([t.date,t.startTime||'',t.endTime||'',t.platform,t.mode,
      t.pickup?.town||'',t.pickup?.addr||'',t.dropoff?.town||'',t.dropoff?.addr||'',
      t.distanceKm||0,t.durationMins||0,t.fare||0,perKm,t.note||'']);
  });
  dlCSV(rows,'MyDriveLog_Trips_'+fmtDate(new Date())+'.csv');
}

function dlCSV(rows,filename){
  const csv=rows.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download=filename; a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STARTUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startShift(){
  closeOverlay('shift-overlay');
  go('entry',document.getElementById('nav-entry'));
}

window.addEventListener('load',()=>{
  initEntry();
  renderSessions();

  // Restore active trip
  try{
    const s=sessionStorage.getItem('mdl_active');
    if(s){ activeTrip=JSON.parse(s); startTimer(); }
  }catch{}

  window.addEventListener('beforeunload',()=>{
    if(activeTrip) sessionStorage.setItem('mdl_active',JSON.stringify(activeTrip));
    else sessionStorage.removeItem('mdl_active');
  });

  // Startup shift popup â€” once per day
  const today=fmtDate(new Date());
  if(sessionStorage.getItem('mdl_popup')!==today){
    sessionStorage.setItem('mdl_popup',today);
    setTimeout(()=>document.getElementById('shift-overlay').classList.add('open'),500);
  }
});
</script>
</body>
</html>
